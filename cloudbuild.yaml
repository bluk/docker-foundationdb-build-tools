steps:
- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'build'
    - '--tag=gcr.io/$PROJECT_ID/fdb-build-tools:6'
    - '--build-arg'
    - 'FDB_VERSION=${_FDB_VERSION}'
    - '--build-arg'
    - 'FDB_CLIENTS_PKG_SHA256SUM=${_FDB_CLIENTS_PKG_SHA256SUM}'
    - '--build-arg'
    - 'FDB_SERVER_PKG_SHA256SUM=${_FDB_SERVER_PKG_SHA256SUM}'
    - '.'
  id: '6'

# Test versions
- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'run'
    - '--rm'
    - 'gcr.io/$PROJECT_ID/fdb-build-tools:6'
    - 'fdbserver'
    - '--version'
  wait_for: ['6']

# Tag versions
- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'tag'
    - 'gcr.io/$PROJECT_ID/fdb-build-tools:6'
    - 'gcr.io/$PROJECT_ID/fdb-build-tools'
  wait_for: ['6']
  id: 'latest'

- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'tag'
    - 'gcr.io/$PROJECT_ID/fdb-build-tools:6'
    - 'gcr.io/$PROJECT_ID/fdb-build-tools:6.0'
  wait_for: ['6']
  id: '6.0'

- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'tag'
    - 'gcr.io/$PROJECT_ID/fdb-build-tools:6'
    - 'gcr.io/$PROJECT_ID/fdb-build-tools:6.0.15'
  wait_for: ['6']
  id: '6.0.15'

# Test latest
- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'run'
    - '--rm'
    - 'gcr.io/$PROJECT_ID/fdb-build-tools'
    - 'fdbserver'
    - '--version'
  wait_for: ['latest']

substitutions:
  _FDB_VERSION: 6.0.15
  _FDB_CLIENTS_PKG_SHA256SUM: 1b5e799900f8be328d6c32220c399e83cdbaf320b34ffcadc7c1851414d423bd
  _FDB_SERVER_PKG_SHA256SUM: d08c9ceff5c83645cd100eae969d660ab03189251447861e9ab953b60bd3ea7f

images:
- 'gcr.io/$PROJECT_ID/fdb-build-tools:latest'
- 'gcr.io/$PROJECT_ID/fdb-build-tools:6'
- 'gcr.io/$PROJECT_ID/fdb-build-tools:6.0'
- 'gcr.io/$PROJECT_ID/fdb-build-tools:6.0.15'
